package org.gradle.wrapper;

import java.io.File;
import java.io.FilenameFilter;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;

public class BootstrapMainStarter {
    public void start(String[] args, File gradleHome) throws Exception {
        File gradleJar = findLauncherJar(gradleHome);
        
        // Создаем ClassLoader для загрузки Gradle из найденного JAR-файла
        URLClassLoader contextClassLoader = new URLClassLoader(
            new URL[]{gradleJar.toURI().toURL()}, 
            ClassLoader.getSystemClassLoader().getParent()
        );
        
        Thread.currentThread().setContextClassLoader(contextClassLoader);
        
        // Загружаем основной класс Gradle и вызываем метод main через рефлексию
        Class<?> mainClass = contextClassLoader.loadClass("org.gradle.launcher.GradleMain");
        Method mainMethod = mainClass.getMethod("main", String[].class);
        
        mainMethod.invoke(null, new Object[]{args});
        
        // В современных версиях также может потребоваться закрытие загрузчика
        contextClassLoader.close();
    }

    private File findLauncherJar(File gradleHome) {
        File libDirectory = new File(gradleHome, "lib");
        if (!libDirectory.isDirectory()) {
            throw new RuntimeException(String.format("Could not locate the Gradle launcher JAR in Gradle distribution '%s'.", gradleHome));
        }
        
        // Ищем файл, подходящий под шаблон gradle-launcher-*.jar
        File[] launcherJars = libDirectory.listFiles(new FilenameFilter() {
            public boolean accept(File dir, String name) {
                return name.startsWith("gradle-launcher-") && name.endsWith(".jar");
            }
        });

        if (launcherJars == null || launcherJars.length == 0) {
            throw new RuntimeException(String.format("Could not locate the Gradle launcher JAR in Gradle distribution '%s'.", gradleHome));
        }
        
        return launcherJars[0];
    }
}
